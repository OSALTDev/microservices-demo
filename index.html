<!DOCTYPE html>
<html lang="en-us">
  <head>
    <meta charset="UTF-8">
    <title>Microservices-demo with Docker Swarm and HA Proxy (Interlock) by anokun7</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" type="text/css" href="stylesheets/normalize.css" media="screen">
    <link href='https://fonts.googleapis.com/css?family=Open+Sans:400,700' rel='stylesheet' type='text/css'>
    <link rel="stylesheet" type="text/css" href="stylesheets/stylesheet.css" media="screen">
    <link rel="stylesheet" type="text/css" href="stylesheets/github-light.css" media="screen">
  </head>
  <body>
    <section class="page-header">
      <h1 class="project-name">Microservices-demo with Docker Swarm and HA Proxy (Interlock)</h1>
      <h2 class="project-tagline">A very simple Go-Redis app to demo discovery of multiple services behind a haproxy load balanced (using the interlock plugin system)</h2>
      <a href="https://github.com/anokun7/microservices-demo" class="btn">View on GitHub</a>
      <a href="https://github.com/anokun7/microservices-demo/zipball/master" class="btn">Download .zip</a>
      <a href="https://github.com/anokun7/microservices-demo/tarball/master" class="btn">Download .tar.gz</a>
    </section>

    <section class="main-content">
      <h1>
<a id="microservices-demo" class="anchor" href="#microservices-demo" aria-hidden="true"><span class="octicon octicon-link"></span></a>microservices-demo</h1>

<p>A very simple Go-Redis app to demo discovery of multiple services behind a haproxy load balanced (using the interlock plugin system).</p>

<p>This demo uses Docker Swarm, docker-compose and HA Proxy as the load balancer service through the interlock plugin system. If you need a simpler demo that does not use docker-compose, try <a href="http://anokun7.github.io/interlock-demo/">the interlock-demo</a>.</p>

<h3>
<a id="pre-requisites" class="anchor" href="#pre-requisites" aria-hidden="true"><span class="octicon octicon-link"></span></a>Pre-requisites</h3>

<ol>
<li>Ensure Docker Swarm is working. An effective demo would require at least 3 active nodes in the swarm.</li>
<li>Docker version &gt; 1.8</li>
<li>Set the <code>DOCKER_HOST</code> environment variable to the Docker Swarm's tcp endpoint. Do not use localhost, even if you are on the Docker Swarm manager / master. Example: <code>export DOCKER_HOST=tcp://10.0.0.6:9999</code>.</li>
<li>
<code>docker info</code> should show the nodes added to the cluster.</li>
</ol>

<h3>
<a id="steps" class="anchor" href="#steps" aria-hidden="true"><span class="octicon octicon-link"></span></a>Steps</h3>

<ol>
<li>On any node that is part of the cluster, run a container from the ehazlett/interlock image using the command below. We want to use the haproxy plugin for this lab.
<code>
docker run -p 80:80 --name lb0 -d ehazlett/interlock --swarm-url $DOCKER_HOST --plugin haproxy start
</code>
</li>
<li>Due to the cluster scheduling, the haproxy container may actually be running on a different host than the one where the above command was run. Use <code>docker ps | grep lb0</code> to identify the host it is running on.

<ul>
<li>Alternatively, specify a filter (ie., affinity:nodename or constraint:container) to restrict the container to a specific docker host.</li>
</ul>
</li>
<li>Clone this repo to a local folder. <code>git clone https://github.com/anokun7/microservices-demo.git</code>
</li>
<li><code>cd microservices-demo</code></li>
<li>
<p>Use docker-compose to build and run the web app containers. <code>docker-compose up -d</code></p>

<pre><code>vagrant@ubuntu5:/vagrant/microservices-demo$ docker-compose up -d 
Creating microservicesdemo_dbdata_1...
Creating microservicesdemo_db_1...
Creating microservicesdemo_web_1...
</code></pre>
</li>
<li>Every container started in a swarm cluster gets registered to the ha-proxy as a backend as long as the container has an exposed port and a hostname.

<ul>
<li>The hostname for the <code>web</code> container is configured in the <code>docker-compose.yml</code> using the <code>INTERLOCK_DATA</code> environment variable.</li>
</ul>
</li>
<li>
<p>Let's again use docker-compose to scale up the number of web containers to 9. Each of these 9 web containers will also get registered to the same backend in the HA Proxy config.</p>

<pre><code>vagrant@ubuntu5:/vagrant/microservices-demo$ docker-compose scale web=9
Creating microservicesdemo_web_2...
Creating microservicesdemo_web_3...
Creating microservicesdemo_web_4...
Creating microservicesdemo_web_5...
Creating microservicesdemo_web_6...
Creating microservicesdemo_web_7...
Creating microservicesdemo_web_8...
Creating microservicesdemo_web_9...
Starting microservicesdemo_web_2...
Starting microservicesdemo_web_3...
Starting microservicesdemo_web_4...
Starting microservicesdemo_web_5...
Starting microservicesdemo_web_6...
Starting microservicesdemo_web_7...
Starting microservicesdemo_web_8...
Starting microservicesdemo_web_9...
</code></pre>

<ul>
<li>Tha HA Proxy stats page should (auto) refresh to show the newly registered backends, like below:
<img src="https://farm1.staticflickr.com/651/21717537885_0c6a3ec632_b.jpg" alt="HA Proxy stats">
</li>
</ul>
</li>
<li>Ensure DNS is setup (or add entries to <code>/etc/hosts</code> file) to resolve the host where the <code>lb0</code> container is running.</li>
<li>Browse to the URL: <code>http://[host-ip-running-lb0]/demo</code>

<ul>
<li><img src="https://farm1.staticflickr.com/666/21705956952_9b3bfea89f_b.jpg" width="300"></li>
</ul>
</li>
<li>Every time a container responds to the HTTP request, it should get its counter incremented. The counter is being stored (and retrieved) from a REDIS backend database.</li>
</ol>

      <footer class="site-footer">
        <span class="site-footer-owner"><a href="https://github.com/anokun7/microservices-demo">Microservices-demo with Docker Swarm and HA Proxy (Interlock)</a> is maintained by <a href="https://github.com/anokun7">anokun7</a>.</span>

        <span class="site-footer-credits">This page was generated by <a href="https://pages.github.com">GitHub Pages</a> using the <a href="https://github.com/jasonlong/cayman-theme">Cayman theme</a> by <a href="https://twitter.com/jasonlong">Jason Long</a>.</span>
      </footer>

    </section>

            <script type="text/javascript">
            var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
            document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
          </script>
          <script type="text/javascript">
            try {
              var pageTracker = _gat._getTracker("UA-1020564-1");
            pageTracker._trackPageview();
            } catch(err) {}
          </script>

  </body>
</html>
