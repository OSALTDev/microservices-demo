<!DOCTYPE html>
<html lang="en-us">
  <head>
    <meta charset="UTF-8">
    <title>Microservices-demo with Docker Swarm and HA Proxy (Interlock) by anokun7</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" type="text/css" href="stylesheets/normalize.css" media="screen">
    <link href='https://fonts.googleapis.com/css?family=Open+Sans:400,700' rel='stylesheet' type='text/css'>
    <link rel="stylesheet" type="text/css" href="stylesheets/stylesheet.css" media="screen">
    <link rel="stylesheet" type="text/css" href="stylesheets/github-light.css" media="screen">
  </head>
  <body>
    <section class="page-header">
      <h1 class="project-name">Microservices-demo with Docker Swarm and HA Proxy (Interlock)</h1>
      <h2 class="project-tagline">A very simple Go-Redis app to demo discovery of multiple services behind a haproxy load balanced (using the interlock plugin system)</h2>
      <a href="https://github.com/anokun7/microservices-demo" class="btn">View on GitHub</a>
      <a href="https://github.com/anokun7/microservices-demo/zipball/master" class="btn">Download .zip</a>
      <a href="https://github.com/anokun7/microservices-demo/tarball/master" class="btn">Download .tar.gz</a>
    </section>

    <section class="main-content">
      <h1>
<a id="microservices-demo" class="anchor" href="#microservices-demo" aria-hidden="true"><span class="octicon octicon-link"></span></a>microservices-demo</h1>

<p>A very simple Go-Redis app to demo discovery of multiple services behind a haproxy load balanced (using the interlock plugin system).</p>

<p>This demo uses Docker Swarm, docker-compose and HA Proxy as the load balancer service through the interlock plugin system. If you need a simpler demo that does not use docker-compose, try <a href="http://anokun7.github.io/interlock-demo/">the interlock-demo</a>.</p>

<h3>
<a id="pre-requisites" class="anchor" href="#pre-requisites" aria-hidden="true"><span class="octicon octicon-link"></span></a>Pre-requisites</h3>

<ol>
<li>Ensure Docker Swarm is working. An effective demo would require at least 3 active nodes in the swarm.</li>
<li>Docker version &gt; 1.8, docker-compose version &gt; 1.3.1, and Swarm version &gt; 0.4</li>
<li>Set the <code>DOCKER_HOST</code> environment variable to the Docker Swarm's tcp endpoint. Do not use localhost, even if you are on the Docker Swarm manager / master. Example: <code>export DOCKER_HOST=tcp://10.0.0.6:9999</code>.</li>
<li>
<code>docker info</code> should show the nodes added to the cluster.</li>
</ol>

<h3>
<a id="steps" class="anchor" href="#steps" aria-hidden="true"><span class="octicon octicon-link"></span></a>Steps</h3>

<ol>
<li>Clone this repo to a local folder. <code>git clone https://github.com/anokun7/microservices-demo.git</code>
</li>
<li><code>cd microservices-demo</code></li>
<li>
<p>Use docker-compose to build and run the web app containers. <code>docker-compose up -d</code></p>

<pre><code>vagrant@ubuntu5:~/microservices-demo$ docker-compose stop ; docker-compose rm -f ; docker-compose up -d
Stopping microservicesdemo_db_1... done
Stopping microservicesdemo_lb_1... done
Stopping microservicesdemo_dbdata_1... done
Going to remove microservicesdemo_db_1, microservicesdemo_lb_1, microservicesdemo_dbdata_1
Removing microservicesdemo_db_1... done
Removing microservicesdemo_lb_1... done
Removing microservicesdemo_dbdata_1... done
Creating microservicesdemo_dbdata_1...
Creating microservicesdemo_lb_1...
Creating microservicesdemo_db_1...
Creating microservicesdemo_web_1...
</code></pre>
</li>
<li>Every container started in a swarm cluster gets registered to the ha-proxy as a backend as long as the container has an exposed port and a hostname.

<ul>
<li>The hostname for the <code>web</code> container is configured in the <code>docker-compose.yml</code> using the <code>INTERLOCK_DATA</code> environment variable.</li>
</ul>
</li>
<li>
<p>Let's again use docker-compose to scale up the number of web containers to 10. Each of these 10 web containers will also get registered to the same backend in the HA Proxy config.</p>

<pre><code>vagrant@ubuntu5:~/microservices-demo$ docker-compose scale web=10
Creating and starting 2... done
Creating and starting 3... done
Creating and starting 4... done
Creating and starting 5... done
Creating and starting 6... done
Creating and starting 7... done
Creating and starting 8... done
Creating and starting 9... done
Creating and starting 10... done
</code></pre>
</li>
<li>Tha HA Proxy stats page should (auto) refresh to show the newly registered backends, like below:

<ul>
<li>It may be necessary to restart the lb (load balancer) container running HA Proxy. Do this if you do not see any backends registering after the scale up action.</li>
</ul>

<pre><code>vagrant@ubuntu5:~/microservices-demo$ docker-compose restart lb
Restarting microservicesdemo_lb_1...
</code></pre>

<p><img src="https://farm1.staticflickr.com/651/21717537885_0c6a3ec632_b.jpg" alt="HA Proxy stats"></p>
</li>
<li>Ensure DNS is setup (or add entries to <code>/etc/hosts</code> file) to resolve the host where the <code>lb0</code> container is running.</li>
<li>Browse to the URL: <code>http://[host-ip-running-lb0]/demo</code>

<ul>
<li><img src="https://farm1.staticflickr.com/666/21705956952_9b3bfea89f_b.jpg" width="300"></li>
</ul>
</li>
<li>Every time a container responds to the HTTP request, it will get its counter incremented (on a browser refresh). The counter is being stored (and retrieved) from a REDIS backend database.</li>
<li>Using docker-compose, you can scale up or down the web containers as you wish based on the needs and traffic to your application.</li>
</ol>

      <footer class="site-footer">
        <span class="site-footer-credits"><a href="https://anokun7.github.io">Home</a></span>
	<hr/>
        <span class="site-footer-owner"><a href="https://github.com/anokun7/microservices-demo">Microservices-demo with Docker Swarm and HA Proxy (Interlock)</a> is maintained by <a href="https://github.com/anokun7">anokun7</a>.</span>

      </footer>

    </section>

            <script type="text/javascript">
            var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
            document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
          </script>
          <script type="text/javascript">
            try {
              var pageTracker = _gat._getTracker("UA-1020564-1");
            pageTracker._trackPageview();
            } catch(err) {}
          </script>

  </body>
</html>
