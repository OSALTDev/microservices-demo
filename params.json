{"name":"Microservices-demo with Docker Swarm and HA Proxy (Interlock)","tagline":"A very simple Go-Redis app to demo discovery of multiple services behind a haproxy load balanced (using the interlock plugin system)","body":"# microservices-demo\r\nA very simple Go-Redis app to demo discovery of multiple services behind a haproxy load balanced (using the interlock plugin system).\r\n\r\nThis demo uses Docker Swarm, docker-compose and HA Proxy as the load balancer service through the interlock plugin system. If you need a simpler demo that does not use docker-compose, try [the interlock-demo](http://anokun7.github.io/interlock-demo/).\r\n\r\n### Pre-requisites\r\n1. Ensure Docker Swarm is working. An effective demo would require at least 3 active nodes in the swarm.\r\n2. Docker version > 1.8, docker-compose version > 1.3.1, and Swarm version > 0.4\r\n3. Set the `DOCKER_HOST` environment variable to the Docker Swarm's tcp endpoint. Do not use localhost, even if you are on the Docker Swarm manager / master. Example: `export DOCKER_HOST=tcp://10.0.0.6:9999`.\r\n4. `docker info` should show the nodes added to the cluster.\r\n\r\n### Steps\r\n1. Clone this repo to a local folder. `git clone https://github.com/anokun7/microservices-demo.git`\r\n2. `cd microservices-demo`\r\n3. Use docker-compose to build and run the web app containers. `docker-compose up -d`\r\n\r\n  ```\r\n  vagrant@ubuntu5:~/microservices-demo$ docker-compose stop ; docker-compose rm -f ; docker-compose up -d\r\n  Stopping microservicesdemo_db_1... done\r\n  Stopping microservicesdemo_lb_1... done\r\n  Stopping microservicesdemo_dbdata_1... done\r\n  Going to remove microservicesdemo_db_1, microservicesdemo_lb_1, microservicesdemo_dbdata_1\r\n  Removing microservicesdemo_db_1... done\r\n  Removing microservicesdemo_lb_1... done\r\n  Removing microservicesdemo_dbdata_1... done\r\n  Creating microservicesdemo_dbdata_1...\r\n  Creating microservicesdemo_lb_1...\r\n  Creating microservicesdemo_db_1...\r\n  Creating microservicesdemo_web_1...\r\n  ```\r\n4. Every container started in a swarm cluster gets registered to the ha-proxy as a backend as long as the container has an exposed port and a hostname.\r\n  - The hostname for the `web` container is configured in the `docker-compose.yml` using the `INTERLOCK_DATA` environment variable.\r\n5. Let's again use docker-compose to scale up the number of web containers to 10. Each of these 10 web containers will also get registered to the same backend in the HA Proxy config.\r\n \r\n  ```\r\n  vagrant@ubuntu5:~/microservices-demo$ docker-compose scale web=10\r\n  Creating and starting 2... done\r\n  Creating and starting 3... done\r\n  Creating and starting 4... done\r\n  Creating and starting 5... done\r\n  Creating and starting 6... done\r\n  Creating and starting 7... done\r\n  Creating and starting 8... done\r\n  Creating and starting 9... done\r\n  Creating and starting 10... done\r\n  ```\r\n6. Tha HA Proxy stats page should (auto) refresh to show the newly registered backends, like below:\r\n  - It may be necessary to restart the lb (load balancer) container running HA Proxy. Do this if you do not see any backends registering after the scale up action.\r\n  ```\r\n  vagrant@ubuntu5:~/microservices-demo$ docker-compose restart lb\r\n  Restarting microservicesdemo_lb_1...\r\n  ```\r\n  ![HA Proxy stats](https://farm1.staticflickr.com/651/21717537885_0c6a3ec632_b.jpg)\r\n7. Ensure DNS is setup (or add entries to `/etc/hosts` file) to resolve the host where the `lb0` container is running.\r\n8. Browse to the URL: `http://[host-ip-running-lb0]/demo`\r\n  - <img src=\"https://farm1.staticflickr.com/666/21705956952_9b3bfea89f_b.jpg\" width=300>\r\n9. Every time a container responds to the HTTP request, it will get its counter incremented (on a browser refresh). The counter is being stored (and retrieved) from a REDIS backend database.\r\n10. Using docker-compose, you can scale up or down the web containers as you wish based on the needs and traffic to your application.\r\n","google":"UA-1020564-1","note":"Don't delete this file! It's used internally to help with page regeneration."}